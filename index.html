<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowBoard</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/jpeg" href="https://live.staticflickr.com/65535/54706797821_2d5dc29827_w.jpg">
    <link rel="apple-touch-icon" href="https://live.staticflickr.com/65535/54706797821_2d5dc29827_w.jpg">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlowBoard">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Sarabun for Thai) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: none; overscroll-behavior: none; }
        /* Hide scrollbar for clean look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 h-screen w-screen overflow-hidden overscroll-none">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, StickyNote, Type, Image as ImageIcon, Link as LinkIcon, 
            Move, ZoomIn, ZoomOut, Maximize, X, Trash2, CheckCircle, 
            Clock, AlertCircle, ArrowLeft, Book, MoreVertical, Edit2, 
            FolderOpen, PenTool, Undo, Redo, Calendar as CalendarIcon, 
            ChevronLeft, ChevronRight, Filter, LogOut, User, Loader2, Mail,
            Touchpad, MousePointer2
        } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            signOut, onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, addDoc, 
            deleteDoc, onSnapshot, serverTimestamp, getDoc, Timestamp 
        } from 'firebase/firestore';

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyChLR9pMmY1QCgD2HjJ0GjTGS5mx6tG0N8",
            authDomain: "lnwlawyer.firebaseapp.com",
            projectId: "lnwlawyer",
            storageBucket: "lnwlawyer.firebasestorage.app",
            messagingSenderId: "105328800542",
            appId: "1:105328800542:web:7be90ebd1937e98a548f0f",
            measurementId: "G-RN817Q6CXT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global App ID
        const appId = 'flowboard-v1';

        // --- Helper Functions ---
        const getSvgPathFromStroke = (stroke) => {
            if (!stroke || !stroke.length) return "";
            return `M ${stroke.map(p => `${p.x},${p.y}`).join(" L ")}`;
        };

        // --- Components ---

        // 1. Auth Component
        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleGoogleLogin = async () => {
                setLoading(true);
                setError('');
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-600">
                                <Move className="w-10 h-10" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">ยินดีต้อนรับสู่ FlowBoard</h1>
                            <p className="text-gray-500 mt-2">พื้นที่สำหรับความคิดสร้างสรรค์ของคุณ</p>
                        </div>

                        {error && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm flex items-center gap-2">
                                <AlertCircle className="w-4 h-4" /> {error}
                            </div>
                        )}

                        <form onSubmit={handleEmailAuth} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                                <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="name@example.com" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                                <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="••••••••" />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : (isLogin ? 'เข้าสู่ระบบ' : 'สมัครสมาชิก')}
                            </button>
                        </form>

                        <div className="relative my-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div>
                            <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">หรือ</span></div>
                        </div>

                        <button onClick={handleGoogleLogin} disabled={loading} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <span className="text-xl font-bold text-blue-600">G</span> ดำเนินการต่อด้วย Google
                        </button>

                        <p className="mt-6 text-center text-sm text-gray-600">
                            {isLogin ? "ยังไม่มีบัญชี?" : "มีบัญชีอยู่แล้ว?"}
                            <button onClick={() => setIsLogin(!isLogin)} className="ml-1 text-blue-600 font-bold hover:underline">{isLogin ? "สมัครสมาชิก" : "เข้าสู่ระบบ"}</button>
                        </p>
                    </div>
                </div>
            );
        };

        // 2. Connection Layer
        const ConnectionLayer = ({ connections, items }) => {
            return (
                <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0 overflow-visible">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                        </marker>
                    </defs>
                    {connections.map((conn) => {
                        const fromItem = items.find((i) => i.id === conn.from);
                        const toItem = items.find((i) => i.id === conn.to);
                        if (!fromItem || !toItem) return null;
                        const startX = fromItem.x + fromItem.width / 2;
                        const startY = fromItem.y + fromItem.height / 2;
                        const endX = toItem.x + toItem.width / 2;
                        const endY = toItem.y + toItem.height / 2;
                        return (
                            <g key={conn.id}>
                                <line x1={startX} y1={startY} x2={endX} y2={endY} stroke="#94a3b8" strokeWidth="2" markerEnd="url(#arrowhead)" strokeDasharray={conn.type === 'dashed' ? "5,5" : "0"} />
                            </g>
                        );
                    })}
                </svg>
            );
        };

        // 3. Canvas Item
        const CanvasItem = ({ item, isSelected, onPointerDown, onSelect, onEdit }) => {
            const getBorderColor = () => {
                if (isSelected) return 'ring-2 ring-blue-500 shadow-xl';
                if (item.type === 'drawing') return isSelected ? 'ring-2 ring-blue-500' : '';
                return 'shadow-md border-gray-200';
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'done': return <CheckCircle className="w-4 h-4 text-green-500" />;
                    case 'doing': return <Clock className="w-4 h-4 text-amber-500" />;
                    default: return <AlertCircle className="w-4 h-4 text-gray-400" />;
                }
            };

            const baseStyle = {
                transform: `translate(${item.x}px, ${item.y}px)`,
                width: `${item.width}px`,
                height: item.type === 'note' ? `${item.width}px` : `${item.height}px`,
                touchAction: 'none' // Critical for mobile dragging
            };

            if (item.type === 'drawing') {
                return (
                    <div className={`absolute cursor-move select-none ${isSelected ? 'z-20' : 'z-10'}`} style={{...baseStyle, pointerEvents: 'all'}} onPointerDown={(e) => onPointerDown(e, item)} onClick={(e) => { e.stopPropagation(); onSelect(item.id); }}>
                        <div className={`w-full h-full ${isSelected ? 'ring-2 ring-blue-500 ring-offset-4 rounded-sm' : ''}`}>
                            <svg width="100%" height="100%" viewBox={`0 0 ${item.width} ${item.height}`} className="overflow-visible">
                                <path d={getSvgPathFromStroke(item.points)} stroke={item.color || "#000"} strokeWidth="4" fill="none" strokeLinecap="round" strokeLinejoin="round" />
                            </svg>
                        </div>
                        {isSelected && (
                             <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-full px-2 py-1 flex gap-2 border border-gray-200 z-30">
                                <button onPointerDown={(e) => { e.stopPropagation(); onEdit(item); }} className="p-2 hover:bg-gray-100 rounded-full text-red-500"><Trash2 className="w-4 h-4" /></button>
                            </div>
                        )}
                    </div>
                );
            }

            if (item.type === 'note') {
                return (
                    <div className={`absolute cursor-move p-4 transition-shadow select-none ${item.color} ${isSelected ? 'ring-2 ring-blue-500 z-20' : 'z-10'}`} style={baseStyle} onPointerDown={(e) => onPointerDown(e, item)} onClick={(e) => { e.stopPropagation(); onSelect(item.id); }}>
                        <div className="font-handwriting text-lg leading-tight text-gray-800 break-words h-full overflow-hidden pointer-events-none">{item.content || "โน้ตใหม่..."}</div>
                         {isSelected && (
                            <div className="absolute -top-3 -right-3 flex gap-1">
                                <button onPointerDown={(e) => { e.stopPropagation(); onEdit(item); }} className="bg-white p-2 rounded-full shadow border text-blue-600 hover:bg-blue-50"><Edit2 className="w-4 h-4" /></button>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`absolute bg-white rounded-lg border flex flex-col cursor-move transition-all select-none ${getBorderColor()} ${isSelected ? 'z-20' : 'z-10'}`} style={{...baseStyle, height: 'auto', minHeight: `${item.height}px`}} onPointerDown={(e) => onPointerDown(e, item)} onClick={(e) => { e.stopPropagation(); onSelect(item.id); }}>
                    <div className={`h-2 w-full rounded-t-lg ${item.color || 'bg-gray-200'}`} />
                    <div className="p-3 flex flex-col gap-2">
                        <div className="flex justify-between items-start">
                            <h3 className="font-bold text-gray-800 leading-snug pointer-events-none">{item.title || "ชื่องานใหม่"}</h3>
                            {getStatusIcon(item.status)}
                        </div>
                        <p className="text-xs text-gray-500 line-clamp-3 pointer-events-none">{item.content || "คำอธิบายงาน..."}</p>
                        <div className="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center pointer-events-none">
                            <span className="text-[10px] px-2 py-0.5 bg-gray-100 rounded text-gray-500 font-mono">ID-{item.id.toString().slice(-4)}</span>
                            {item.assignee && (<div className="w-5 h-5 rounded-full bg-blue-100 text-blue-600 text-[10px] flex items-center justify-center font-bold">{item.assignee[0]}</div>)}
                        </div>
                    </div>
                    {/* Toolbar for Touch Devices (Always visible when selected) */}
                    {isSelected && (
                         <div className="absolute -top-12 left-0 w-full flex justify-center z-30 pointer-events-auto">
                             <div className="bg-white shadow-xl rounded-full px-3 py-1.5 flex gap-2 border border-gray-200">
                                <button onPointerDown={(e) => { e.stopPropagation(); onEdit(item); }} className="p-2 hover:bg-gray-100 rounded-full text-blue-600"><Edit2 className="w-4 h-4" /></button>
                                <div className="w-px bg-gray-200 mx-1"></div>
                                {/* Deletion is handled inside Edit Modal or via drag to trash (future) */}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. Mini Map
        const MiniMap = ({ items, viewport, setViewport }) => {
            const bounds = useMemo(() => {
                if (items.length === 0) return { minX: 0, maxX: 2000, minY: 0, maxY: 1000 };
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                items.forEach(i => {
                    minX = Math.min(minX, i.x); maxX = Math.max(maxX, i.x + i.width); minY = Math.min(minY, i.y); maxY = Math.max(maxY, i.y + i.height);
                });
                return { minX: minX - 500, maxX: maxX + 500, minY: minY - 500, maxY: maxY + 500 };
            }, [items]);

            const mapWidth = 160; const mapHeight = 100;
            const worldWidth = bounds.maxX - bounds.minX || 1; const worldHeight = bounds.maxY - bounds.minY || 1;
            const scaleX = mapWidth / worldWidth; const scaleY = mapHeight / worldHeight;
            const scale = Math.min(scaleX, scaleY);

            return (
                <div className="fixed bottom-20 right-4 w-32 h-20 sm:w-40 sm:h-24 bg-white border border-gray-300 shadow-lg rounded-md overflow-hidden opacity-90 hover:opacity-100 transition-opacity z-40 hidden sm:block">
                    <div className="relative w-full h-full bg-gray-50">
                        {items.map(item => (
                            <div key={item.id} className={`absolute ${item.type === 'note' ? item.color.replace('bg-', 'bg-') : item.type === 'drawing' ? 'bg-transparent border border-gray-400' : 'bg-gray-400'}`} style={{ left: (item.x - bounds.minX) * scale, top: (item.y - bounds.minY) * scale, width: Math.max(2, item.width * scale), height: Math.max(2, (item.type === 'note' ? item.width : item.height) * scale), borderRadius: '1px' }} />
                        ))}
                        <div className="absolute border-2 border-red-500 bg-red-500/10 pointer-events-none" style={{ left: (-viewport.x - bounds.minX) * scale, top: (-viewport.y - bounds.minY) * scale, width: (window.innerWidth / viewport.scale) * scale, height: (window.innerHeight / viewport.scale) * scale }} />
                    </div>
                </div>
            );
        };

        // 5. Edit Modal
        const EditModal = ({ item, isOpen, onClose, onSave, onDelete }) => {
            const [data, setData] = useState({ ...item });
            useEffect(() => { setData({ ...item }); }, [item]);
            if (!isOpen || !item) return null;

            if (item.type === 'drawing') {
                return (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden p-6 text-center animate-in fade-in zoom-in duration-200">
                            <h3 className="text-lg font-bold mb-4">จัดการรูปวาด</h3>
                            <div className="flex gap-4 justify-center">
                                <button onClick={() => { onDelete(item.id); onClose(); }} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> ลบรูปวาด</button>
                                <button onClick={onClose} className="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">ปิด</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in duration-200">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-gray-700">{item.type === 'note' ? <StickyNote className="w-5 h-5" /> : <CheckCircle className="w-5 h-5" />} {item.type === 'note' ? 'แก้ไขโน้ต' : 'รายละเอียดงาน'}</h2>
                            <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            {item.type !== 'note' && (<div><label className="block text-sm font-medium text-gray-700 mb-1">หัวข้อ</label><input type="text" value={data.title || ''} onChange={(e) => setData({...data, title: e.target.value})} className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>)}
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">รายละเอียด</label><textarea value={data.content || ''} onChange={(e) => setData({...data, content: e.target.value})} rows={6} className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none resize-none" /></div>
                            <div className="flex gap-4">
                                <div className="flex-1"><label className="block text-sm font-medium text-gray-700 mb-1">สี</label><div className="flex gap-2">{['bg-yellow-200', 'bg-blue-200', 'bg-green-200', 'bg-red-200', 'bg-white'].map(color => (<button key={color} onClick={() => setData({...data, color})} className={`w-6 h-6 rounded-full border border-gray-300 ${color} ${data.color === color ? 'ring-2 ring-offset-1 ring-gray-400' : ''}`} />))}</div></div>
                                {item.type !== 'note' && (<div className="flex-1"><label className="block text-sm font-medium text-gray-700 mb-1">สถานะ</label><select value={data.status || 'todo'} onChange={(e) => setData({...data, status: e.target.value})} className="w-full p-2 border rounded-md bg-white"><option value="todo">To Do</option><option value="doing">Doing</option><option value="done">Done</option></select></div>)}
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                            <button onClick={() => { onDelete(item.id); onClose(); }} className="text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-2 rounded-md flex items-center gap-1 transition-colors"><Trash2 className="w-4 h-4" /> ลบ</button>
                            <button onClick={() => { onSave(data); onClose(); }} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md shadow-sm font-medium transition-colors">บันทึก</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Confirm Modal
        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] flex items-center justify-center p-4" onClick={onCancel}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                        <div className="p-6 text-center">
                            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><AlertCircle className="w-6 h-6 text-red-600" /></div>
                            <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
                            <p className="text-gray-500 text-sm mb-6">{message}</p>
                            <div className="flex gap-3 justify-center">
                                <button onClick={onCancel} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">ยกเลิก</button>
                                <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">ยืนยันการลบ</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Calendar Widget
        const CalendarWidget = ({ notebooks, selectedDate, onSelectDate }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const daysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const totalDays = daysInMonth(currentDate);
            const startDay = firstDayOfMonth(currentDate);
            const hasActivity = (day) => {
                const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                return notebooks.some(nb => {
                    const updatedAt = nb.updatedAt;
                    return updatedAt && new Date(updatedAt).toDateString() === checkDate;
                });
            };
            const isSelected = (day) => {
                if (!selectedDate) return false;
                const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                return selectedDate.toDateString() === checkDate;
            };
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-gray-700 text-lg">{months[currentDate.getMonth()]} {currentDate.getFullYear() + 543}</h3>
                        <div className="flex gap-1">
                            <button onClick={prevMonth} className="p-1 hover:bg-gray-100 rounded-full"><ChevronLeft className="w-5 h-5 text-gray-500" /></button>
                            <button onClick={nextMonth} className="p-1 hover:bg-gray-100 rounded-full"><ChevronRight className="w-5 h-5 text-gray-500" /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center mb-2">{['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'].map(d => (<div key={d} className="text-xs font-medium text-gray-400">{d}</div>))}</div>
                    <div className="grid grid-cols-7 gap-1">
                        {[...Array(startDay)].map((_, i) => <div key={`empty-${i}`} />)}
                        {[...Array(totalDays)].map((_, i) => {
                            const day = i + 1; const active = hasActivity(day); const selected = isSelected(day);
                            return (<button key={day} onClick={() => onSelectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), day))} className={`h-8 w-8 rounded-full flex items-center justify-center text-sm relative transition-all ${selected ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-gray-100 text-gray-700'} ${!selected && active ? 'font-bold' : ''}`}>{day}{active && !selected && (<div className="absolute bottom-1 w-1 h-1 bg-blue-500 rounded-full"></div>)}</button>);
                        })}
                    </div>
                    {selectedDate && (<button onClick={() => onSelectDate(null)} className="w-full mt-4 text-xs text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1"><X className="w-3 h-3" /> ล้างตัวกรองวันที่</button>)}
                </div>
            );
        };

        // Dashboard
        const Dashboard = ({ user, notebooks, onSelectNotebook, onCreateNotebook, onDeleteNotebook, onRenameNotebook, selectedDate, onSelectDate }) => {
            const [isCreating, setIsCreating] = useState(false);
            const [newBookName, setNewBookName] = useState('');
            const getInitialDate = () => { const d = selectedDate || new Date(); return d.toISOString().split('T')[0]; };
            const [newBookDate, setNewBookDate] = useState(getInitialDate());
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [deleteId, setDeleteId] = useState(null);

            useEffect(() => { if (isCreating) { setNewBookDate(getInitialDate()); } }, [isCreating, selectedDate]);

            const handleCreate = (e) => {
                e.preventDefault();
                if (newBookName.trim()) {
                    const dateToUse = newBookDate ? new Date(newBookDate) : new Date();
                    onCreateNotebook(newBookName, dateToUse);
                    setNewBookName('');
                    setIsCreating(false);
                }
            };

            const handleRename = (id) => { if (editName.trim()) { onRenameNotebook(id, editName); } setEditingId(null); };
            const filteredNotebooks = selectedDate ? notebooks.filter(nb => nb.updatedAt && new Date(nb.updatedAt).toDateString() === selectedDate.toDateString()) : notebooks;

            return (
                <div className="min-h-screen bg-gray-50 p-6 md:p-8 font-sans overflow-y-auto">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                            <div><h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3"><Book className="w-8 h-8 text-blue-600" /> ห้องสมุดของฉัน</h1><p className="text-gray-500 mt-1 text-sm pl-11">{selectedDate ? `กิจกรรมวันที่ ${selectedDate.toLocaleDateString('th-TH', { dateStyle: 'long' })}` : 'จัดการความคิดและโปรเจกต์ของคุณในที่เดียว'}</p></div>
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm border border-gray-100">{user.photoURL ? (<img src={user.photoURL} alt="User" className="w-6 h-6 rounded-full" />) : (<User className="w-5 h-5 text-gray-500" />)}<span className="text-sm font-medium text-gray-700 max-w-[100px] truncate">{user.displayName || user.email}</span></div>
                                <button onClick={() => signOut(auth)} className="p-2 hover:bg-gray-200 rounded-full text-gray-600" title="ออกจากระบบ"><LogOut className="w-5 h-5" /></button>
                                <button onClick={() => setIsCreating(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md flex items-center gap-2 transition-all font-medium ml-2"><Plus className="w-5 h-5" /> สร้างสมุดใหม่</button>
                            </div>
                        </div>
                        <div className="flex flex-col lg:flex-row gap-8 items-start">
                            <div className="w-full lg:w-80 flex-shrink-0 space-y-6">
                                <CalendarWidget notebooks={notebooks} selectedDate={selectedDate} onSelectDate={onSelectDate} />
                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100"><h4 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Clock className="w-4 h-4" /> สรุปกิจกรรม</h4><div className="text-sm text-blue-600 space-y-1"><p>• ทั้งหมด {notebooks.length} เล่ม</p><p>• อัปเดตวันนี้ {notebooks.filter(n => n.updatedAt && new Date(n.updatedAt).toDateString() === new Date().toDateString()).length} เล่ม</p></div></div>
                            </div>
                            <div className="flex-1 w-full">
                                {isCreating && (
                                    <form onSubmit={handleCreate} className="mb-6 p-6 bg-white rounded-xl shadow-lg border border-blue-100 animate-in fade-in slide-in-from-top-4">
                                        <h3 className="font-bold text-gray-700 mb-4">สร้างสมุดเล่มใหม่</h3>
                                        <div className="space-y-4">
                                            <div><label className="block text-sm font-medium text-gray-700 mb-1">ชื่อสมุด</label><input autoFocus type="text" value={newBookName} onChange={(e) => setNewBookName(e.target.value)} placeholder="เช่น โปรเจกต์ลับสุดยอด..." className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                                            <div><label className="block text-sm font-medium text-gray-700 mb-1">วันที่สร้าง (สำหรับบันทึกย้อนหลัง/ล่วงหน้า)</label><div className="flex items-center gap-2"><CalendarIcon className="w-5 h-5 text-gray-500" /><input type="date" value={newBookDate} onChange={(e) => setNewBookDate(e.target.value)} className="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none flex-1" /></div></div>
                                            <div className="flex gap-2 pt-2"><button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 flex-1">สร้างเลย</button><button type="button" onClick={() => setIsCreating(false)} className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300">ยกเลิก</button></div>
                                        </div>
                                    </form>
                                )}
                                {filteredNotebooks.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-16 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400"><FolderOpen className="w-16 h-16 mb-4 opacity-50" /><p className="text-lg font-medium">ไม่พบสมุดโน้ต</p>{selectedDate && <p className="text-sm">ไม่มีกิจกรรมในวันที่เลือก</p>}{!selectedDate && <button onClick={() => setIsCreating(true)} className="mt-4 text-blue-600 hover:underline">สร้างสมุดเล่มแรกเลย!</button>}</div>
                                ) : (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                                        {filteredNotebooks.map(book => (
                                            <div key={book.id} onClick={() => onSelectNotebook(book.id)} className="group relative bg-white rounded-xl p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 flex flex-col justify-between h-48">
                                                <div className="absolute top-0 left-0 w-2 h-full bg-blue-500 rounded-l-xl opacity-80 group-hover:bg-blue-600 transition-colors" />
                                                <div>
                                                    <div className="flex justify-between items-start mb-3 pl-3">
                                                        <div className="p-2.5 bg-blue-50 rounded-lg text-blue-600 group-hover:scale-110 transition-transform"><Book className="w-6 h-6" /></div>
                                                        <div className="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1" onClick={e => e.stopPropagation()}>
                                                            <button onClick={() => { setEditingId(book.id); setEditName(book.name); }} className="p-1.5 hover:bg-gray-100 rounded-md text-gray-500"><Edit2 className="w-4 h-4" /></button>
                                                            <button onClick={() => setDeleteId(book.id)} className="p-1.5 hover:bg-red-50 rounded-md text-red-500"><Trash2 className="w-4 h-4" /></button>
                                                        </div>
                                                    </div>
                                                    <div className="pl-3">
                                                        {editingId === book.id ? (<input autoFocus value={editName} onChange={(e) => setEditName(e.target.value)} onBlur={() => handleRename(book.id)} onKeyDown={(e) => e.key === 'Enter' && handleRename(book.id)} onClick={(e) => e.stopPropagation()} className="w-full p-1 border rounded text-lg font-bold" />) : (<h3 className="text-lg font-bold text-gray-800 mb-1 line-clamp-2 leading-tight group-hover:text-blue-700 transition-colors">{book.name}</h3>)}
                                                    </div>
                                                </div>
                                                <div className="pl-3 mt-auto pt-4 border-t border-gray-50 flex items-center gap-2 text-xs text-gray-400"><Clock className="w-3 h-3" /><span>{book.updatedAt ? new Date(book.updatedAt).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit' }) : '-'}</span></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <ConfirmModal isOpen={!!deleteId} title="ยืนยันการลบสมุด" message="การกระทำนี้ไม่สามารถย้อนกลับได้ ข้อมูลทั้งหมดในสมุดนี้จะหายไป คุณต้องการลบใช่หรือไม่?" onConfirm={() => { onDeleteNotebook(deleteId); setDeleteId(null); }} onCancel={() => setDeleteId(null)} />
                    </div>
                </div>
            );
        };

        // App Component
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [activeNotebookId, setActiveNotebookId] = useState(null);
            const [notebooks, setNotebooks] = useState([]);
            const [selectedDate, setSelectedDate] = useState(null);
            const [items, setItems] = useState([]);
            const [connections, setConnections] = useState([]);
            const [history, setHistory] = useState([]);
            const [historyStep, setHistoryStep] = useState(-1);
            const [viewport, setViewport] = useState({ x: 0, y: 0, scale: 1 });
            const [selectedId, setSelectedId] = useState(null);
            const [interactionMode, setInteractionMode] = useState('select');
            const [dragging, setDragging] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [connectStartId, setConnectStartId] = useState(null);
            const [currentStroke, setCurrentStroke] = useState(null);
            const containerRef = useRef(null);

            useEffect(() => { const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setAuthLoading(false); }); return () => unsubscribe(); }, []);

            useEffect(() => {
                if (!user) { setNotebooks([]); return; }
                const notebooksRef = collection(db, 'artifacts', appId, 'users', user.uid, 'notebooks');
                const unsubscribe = onSnapshot(notebooksRef, (snapshot) => {
                    const books = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id, ...data,
                            createdAt: data.createdAt?.toMillis ? data.createdAt.toMillis() : Date.now(),
                            updatedAt: data.updatedAt?.toMillis ? data.updatedAt.toMillis() : Date.now(),
                        };
                    });
                    books.sort((a, b) => b.updatedAt - a.updatedAt);
                    setNotebooks(books);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user || !activeNotebookId) { setItems([]); setConnections([]); return; }
                const canvasDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'canvas_data', activeNotebookId);
                const unsubscribe = onSnapshot(canvasDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setItems(data.items || []);
                        setConnections(data.connections || []);
                        if (history.length === 0) { setHistory([{ items: data.items || [], connections: data.connections || [] }]); setHistoryStep(0); }
                    } else {
                        setItems([]); setConnections([]); setHistory([]); setHistoryStep(-1);
                    }
                    setView('canvas');
                });
                return () => unsubscribe();
            }, [user, activeNotebookId]);

            const saveTimeoutRef = useRef(null);
            useEffect(() => {
                if (!user || !activeNotebookId || view !== 'canvas') return;
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                saveTimeoutRef.current = setTimeout(async () => {
                    try {
                        const canvasDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'canvas_data', activeNotebookId);
                        // Only update canvas items, DO NOT update notebook timestamp
                        await setDoc(canvasDocRef, { items, connections, updatedAt: serverTimestamp() });
                    } catch (err) { console.error("Error saving canvas:", err); }
                }, 1000);
                return () => { if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current); };
            }, [items, connections, activeNotebookId, user, view]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedId && !editingItem) deleteItem(selectedId);
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') { if (e.shiftKey) redo(); else undo(); e.preventDefault(); }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') { redo(); e.preventDefault(); }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedId, editingItem, history, historyStep]);

            const pushToHistory = (newItems, newConnections) => {
                const newHistory = history.slice(0, historyStep + 1);
                newHistory.push({ items: newItems, connections: newConnections });
                if (newHistory.length > 50) newHistory.shift();
                setHistory(newHistory); setHistoryStep(newHistory.length - 1);
            };
            const undo = () => { if (historyStep > 0) { const prev = history[historyStep - 1]; setItems(prev.items); setConnections(prev.connections); setHistoryStep(historyStep - 1); } };
            const redo = () => { if (historyStep < history.length - 1) { const next = history[historyStep + 1]; setItems(next.items); setConnections(next.connections); setHistoryStep(historyStep + 1); } };

            const handleCreateNotebook = async (name, customDate) => {
                if (!user) return;
                try {
                    const timestamp = customDate ? Timestamp.fromDate(customDate) : serverTimestamp();
                    const newBook = { name, createdAt: timestamp, updatedAt: timestamp };
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'notebooks'), newBook);
                } catch (err) { console.error("Error creating notebook:", err); }
            };
            const handleDeleteNotebook = async (id) => {
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notebooks', id));
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'canvas_data', id));
                    if (activeNotebookId === id) { setActiveNotebookId(null); setView('dashboard'); }
                } catch (err) { console.error("Error deleting notebook:", err); }
            };
            const handleRenameNotebook = async (id, newName) => {
                if (!user) return;
                // Rename without changing updatedAt
                try { await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notebooks', id), { name: newName }, { merge: true }); } catch (err) { console.error("Error renaming:", err); }
            };

            const getCanvasCoordinates = (cx, cy) => ({ x: (cx - viewport.x) / viewport.scale, y: (cy - viewport.y) / viewport.scale });
            
            // --- Unified Pointer Events for Touch and Mouse ---
            const handlePointerDown = (e) => {
                // Ignore secondary clicks (right click) if using mouse
                if (e.pointerType === 'mouse' && e.button !== 0) return;

                if (e.target === containerRef.current || e.target.tagName === 'SVG' || interactionMode === 'draw') {
                    if (interactionMode === 'draw') {
                        const { x, y } = getCanvasCoordinates(e.clientX, e.clientY);
                        setCurrentStroke([{x, y}]); 
                        setSelectedId(null); 
                        // Important: Capture pointer to track movement even if it leaves the initial element
                        e.target.setPointerCapture(e.pointerId);
                        return;
                    }
                    if (interactionMode === 'pan' || e.pointerType === 'touch' && e.target === containerRef.current) {
                        setDragging({ type: 'viewport', startX: e.clientX, startY: e.clientY, initialX: viewport.x, initialY: viewport.y }); 
                        setSelectedId(null);
                        e.target.setPointerCapture(e.pointerId);
                        return;
                    }
                    setSelectedId(null);
                }
            };

            const handlePointerMove = (e) => {
                if (interactionMode === 'draw' && currentStroke) { 
                    e.preventDefault(); // Stop scrolling
                    const { x, y } = getCanvasCoordinates(e.clientX, e.clientY); 
                    setCurrentStroke(prev => [...prev, {x, y}]); 
                    return; 
                }
                
                if (!dragging) return;
                e.preventDefault(); // Stop scrolling while dragging
                
                if (dragging.type === 'viewport') { 
                    setViewport({ ...viewport, x: dragging.initialX + (e.clientX - dragging.startX), y: dragging.initialY + (e.clientY - dragging.startY) }); 
                } else if (dragging.type === 'item') {
                    const deltaX = (e.clientX - dragging.startX) / viewport.scale; 
                    const deltaY = (e.clientY - dragging.startY) / viewport.scale;
                    setItems(prev => prev.map(item => item.id === dragging.id ? { ...item, x: dragging.initialItemX + deltaX, y: dragging.initialItemY + deltaY } : item));
                }
            };

            const handlePointerUp = (e) => {
                if (interactionMode === 'draw' && currentStroke) {
                    if (currentStroke.length > 2) {
                        const xs = currentStroke.map(p => p.x), ys = currentStroke.map(p => p.y);
                        const minX = Math.min(...xs), maxX = Math.max(...xs), minY = Math.min(...ys), maxY = Math.max(...ys);
                        const newItems = [...items, { id: Date.now(), type: 'drawing', x: minX, y: minY, width: Math.max(20, maxX - minX), height: Math.max(20, maxY - minY), points: currentStroke.map(p => ({ x: p.x - minX, y: p.y - minY })), color: '#1e293b' }];
                        setItems(newItems); pushToHistory(newItems, connections);
                    }
                    setCurrentStroke(null);
                    // e.target.releasePointerCapture(e.pointerId);
                }
                if (dragging?.type === 'item') {
                    if (Math.abs(dragging.startX - e.clientX) > 5 || Math.abs(dragging.startY - e.clientY) > 5) {
                        pushToHistory(items, connections);
                    }
                }
                setDragging(null);
            };

            const handleWheel = (e) => {
                if (e.ctrlKey) { e.preventDefault(); const newScale = Math.min(Math.max(0.1, viewport.scale - e.deltaY * 0.001), 3); setViewport(prev => ({ ...prev, scale: newScale })); }
                else if (interactionMode === 'pan') { setViewport(prev => ({ ...prev, x: prev.x - e.deltaX, y: prev.y - e.deltaY })); }
            };

            const addItem = (type) => {
                const newItem = { id: Date.now(), type, x: (-viewport.x + window.innerWidth / 2) / viewport.scale - 100, y: (-viewport.y + window.innerHeight / 2) / viewport.scale - 50, width: type === 'note' ? 200 : 250, height: type === 'note' ? 200 : 160, title: type === 'task' ? 'งานใหม่' : '', content: '', color: type === 'task' ? 'bg-gray-500' : 'bg-yellow-200', status: 'todo' };
                const newItems = [...items, newItem]; setItems(newItems); setSelectedId(newItem.id); pushToHistory(newItems, connections);
            };
            const saveItem = (updated) => { const newItems = items.map(i => i.id === updated.id ? updated : i); setItems(newItems); pushToHistory(newItems, connections); };
            const deleteItem = (id) => { const newItems = items.filter(i => i.id !== id); const newConns = connections.filter(c => c.from !== id && c.to !== id); setItems(newItems); setConnections(newConns); setSelectedId(null); pushToHistory(newItems, newConns); };

            const zoom = (delta) => {
                setViewport(prev => ({ ...prev, scale: Math.min(Math.max(0.1, prev.scale + delta), 3) }));
            };

            if (authLoading) return <div className="h-screen w-full flex items-center justify-center bg-gray-50"><Loader2 className="w-8 h-8 animate-spin text-blue-600"/></div>;
            if (!user) return <AuthScreen />;

            if (view === 'dashboard') return <Dashboard user={user} notebooks={notebooks} selectedDate={selectedDate} onSelectDate={(date) => setSelectedDate(selectedDate?.getTime() === date?.getTime() ? null : date)} onSelectNotebook={(id) => setActiveNotebookId(id)} onCreateNotebook={handleCreateNotebook} onDeleteNotebook={handleDeleteNotebook} onRenameNotebook={handleRenameNotebook} />;

            return (
                <div className="w-full h-screen overflow-hidden bg-gray-50 text-slate-800 font-sans relative">
                    <div className="absolute top-4 left-0 right-0 px-4 flex justify-center z-50 pointer-events-none">
                        <div className="bg-white/95 backdrop-blur shadow-lg rounded-2xl p-1.5 flex items-center gap-1 sm:gap-4 border border-gray-200 overflow-x-auto max-w-full pointer-events-auto">
                             <button onClick={() => { setView('dashboard'); setActiveNotebookId(null); }} className="p-2 hover:bg-gray-100 rounded-xl text-gray-600 flex items-center gap-1 shrink-0"><ArrowLeft className="w-5 h-5" /></button>
                             <div className="h-6 w-px bg-gray-300 mx-1 shrink-0"></div>
                             
                             <button onClick={() => addItem('task')} className="flex flex-col items-center group min-w-[40px] shrink-0"><div className="p-2 rounded-xl group-hover:bg-blue-50 text-blue-600"><Plus className="w-6 h-6" /></div></button>
                             <button onClick={() => addItem('note')} className="flex flex-col items-center group min-w-[40px] shrink-0"><div className="p-2 rounded-xl group-hover:bg-yellow-50 text-yellow-500"><StickyNote className="w-6 h-6" /></div></button>
                             
                             <div className="h-6 w-px bg-gray-300 mx-1 shrink-0"></div>
                             
                             <button onClick={() => setInteractionMode(interactionMode === 'draw' ? 'select' : 'draw')} className={`flex flex-col items-center group min-w-[40px] shrink-0 ${interactionMode === 'draw' ? 'text-purple-600' : 'text-gray-500'}`}><div className={`p-2 rounded-xl ${interactionMode === 'draw' ? 'bg-purple-100' : 'group-hover:bg-gray-100'}`}><PenTool className="w-6 h-6" /></div></button>
                             <button onClick={() => setInteractionMode(interactionMode === 'connect' ? 'select' : 'connect')} className={`flex flex-col items-center group min-w-[40px] shrink-0 ${interactionMode === 'connect' ? 'text-blue-600' : 'text-gray-500'}`}><div className={`p-2 rounded-xl ${interactionMode === 'connect' ? 'bg-blue-100' : 'group-hover:bg-gray-100'}`}><LinkIcon className="w-6 h-6" /></div></button>
                             
                             <div className="h-6 w-px bg-gray-300 mx-1 shrink-0 hidden sm:block"></div>
                             
                             <div className="flex gap-1 shrink-0 hidden sm:flex">
                                <button onClick={undo} disabled={historyStep <= 0} className={`p-2 rounded-xl ${historyStep <= 0 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-100'}`}><Undo className="w-5 h-5" /></button>
                                <button onClick={redo} disabled={historyStep >= history.length - 1} className={`p-2 rounded-xl ${historyStep >= history.length - 1 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-100'}`}><Redo className="w-5 h-5" /></button>
                             </div>
                        </div>
                    </div>
                    
                    {/* Floating Zoom Controls for Mobile */}
                     <div className="absolute bottom-6 left-6 bg-white/90 backdrop-blur shadow-md rounded-full p-1 z-50 flex flex-col gap-1 border border-gray-200">
                        <button onClick={() => zoom(0.1)} className="p-3 hover:bg-gray-100 rounded-full active:bg-gray-200"><ZoomIn className="w-6 h-6 text-gray-700" /></button>
                        <button onClick={() => zoom(-0.1)} className="p-3 hover:bg-gray-100 rounded-full active:bg-gray-200"><ZoomOut className="w-6 h-6 text-gray-700" /></button>
                    </div>

                    {interactionMode === 'connect' && <div className="absolute top-24 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg z-50 animate-bounce text-sm whitespace-nowrap">{connectStartId ? "แตะที่ปลายทาง" : "แตะที่ต้นทาง"}</div>}
                    {interactionMode === 'draw' && <div className="absolute top-24 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm whitespace-nowrap">วาดได้เลย (ใช้นิ้วเดียว)</div>}
                    
                    <div ref={containerRef} className={`w-full h-full touch-none select-none ${interactionMode === 'draw' ? 'cursor-crosshair' : 'cursor-default'}`} 
                        onPointerDown={handlePointerDown} 
                        onPointerMove={handlePointerMove} 
                        onPointerUp={handlePointerUp} 
                        onPointerLeave={handlePointerUp}
                        onWheel={handleWheel} 
                        style={{ 
                            backgroundImage: `radial-gradient(#cbd5e1 1px, transparent 1px)`, 
                            backgroundSize: `${20 * viewport.scale}px ${20 * viewport.scale}px`, 
                            backgroundPosition: `${viewport.x}px ${viewport.y}px` 
                        }}>
                        <div style={{ transform: `translate(${viewport.x}px, ${viewport.y}px) scale(${viewport.scale})`, transformOrigin: '0 0', width: '100%', height: '100%' }} className="relative transition-transform duration-75 ease-out">
                            {currentStroke && <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-50 overflow-visible"><path d={getSvgPathFromStroke(currentStroke)} stroke="#000" strokeWidth="4" fill="none" strokeLinecap="round" strokeLinejoin="round" opacity="0.6" /></svg>}
                            <ConnectionLayer connections={connections} items={items} />
                            {items.map(item => (
                                <CanvasItem 
                                    key={item.id} 
                                    item={item} 
                                    isSelected={selectedId === item.id} 
                                    onPointerDown={(e, it) => {
                                        if (interactionMode === 'draw') return; 
                                        if (interactionMode === 'connect') { 
                                            e.stopPropagation(); 
                                            if (!connectStartId) setConnectStartId(it.id); 
                                            else { 
                                                if (connectStartId !== it.id) { 
                                                    const newConn = { id: Date.now().toString(), from: connectStartId, to: it.id, type: 'solid' }; 
                                                    const newConns = [...connections, newConn]; 
                                                    setConnections(newConns); 
                                                    pushToHistory(items, newConns); 
                                                } 
                                                setConnectStartId(null); 
                                                setInteractionMode('select'); 
                                            } 
                                            return; 
                                        } 
                                        e.stopPropagation(); 
                                        e.target.setPointerCapture(e.pointerId);
                                        setDragging({ type: 'item', id: it.id, startX: e.clientX, startY: e.clientY, initialItemX: it.x, initialItemY: it.y }); 
                                        setSelectedId(it.id);
                                    }}
                                    onSelect={setSelectedId} 
                                    onEdit={setEditingItem} 
                                />
                            ))}
                        </div>
                    </div>
                    <MiniMap items={items} viewport={viewport} setViewport={setViewport} />
                    <EditModal item={editingItem} isOpen={!!editingItem} onClose={() => setEditingItem(null)} onSave={saveItem} onDelete={deleteItem} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
